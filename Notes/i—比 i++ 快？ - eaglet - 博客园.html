<html>
<head>
  <title>i—比 i++ 快？ - eaglet - 博客园</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/267864 (zh-CN); Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="511"/>
<h1>i—比 i++ 快？ - eaglet - 博客园</h1>

<div>
<div><div style="background-repeat: initial initial;border-top-width:1px;border-left-width:1px;border-top-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-style:solid;border-top-color:rgb(204, 204, 204);border-right-color:rgb(204, 204, 204);border-bottom-color:rgb(204, 204, 204);border-left-color:rgb(204, 204, 204);border-image:initial;border-bottom-width:2px;border-right-width:2px;padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;margin-bottom:28px;margin-top:10px;font-size:12px;font-family:Verdana, 'Lucida Grande', Arial, Helvetica, sans-serif;margin:0px;position:relative;opacity:1;filter:none;background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);line-height:normal;"><div style="background-image:url(http://www.cnblogs.com/eaglet/archive/2012/05/21/images/icon-titledoc.gif);background-repeat: no-repeat no-repeat;background-color:rgb(238, 238, 238);background-position-x:5px;background-position-y:50%;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(204, 204, 204);padding-top:4px;padding-right:4px;padding-bottom:4px;padding-left:25px;color:rgb(68, 68, 68);font-size:13px;"><h2 style="background-repeat: initial initial;margin-top:0px;font-size:12px;margin-right:0px;margin-bottom:0px;margin-left:0px;"><a href="http://www.cnblogs.com/eaglet/archive/2012/05/21/2511174.html" shape="rect" style="background-repeat: initial initial;color:rgb(34, 51, 85);text-decoration:none;font-size:12px;">i—比 i++ 快？</a>
			</h2>
 			Posted on <span style="background-repeat: initial initial;font-size:13px;">2012-05-21 09:44</span> <a href="http://www.cnblogs.com/eaglet/" shape="rect" style="background-repeat: initial initial;color:rgb(34, 51, 85);text-decoration:none;font-size:13px;">eaglet</a> 阅读(4122) 评论(<span style="background-repeat: initial initial;font-size:13px;">41</span>)  <a href="http://www.cnblogs.com/eaglet/admin/EditPosts.aspx?postid=2511174" rel="nofollow" shape="rect" style="background-repeat: initial initial;color:rgb(34, 51, 85);text-decoration:none;font-size:13px;">编辑</a> <a href="http://www.cnblogs.com/eaglet/archive/2012/05/21/2511174.html#" shape="rect" style="background-repeat: initial initial;color:rgb(34, 51, 85);text-decoration:none;font-size:13px;">收藏</a>
			<img src="i—比 i++ 快？ - eaglet - 博客园_files/Image.jpg" type="image/jpeg" alt="alt" height="1" style="background-repeat: initial initial;border-top-width:0px;border-right-width:0px;border-bottom-width:0px;border-left-width:0px;border-style:initial;border-color:initial;border-image:initial;" width="1"/>
			
		</div>
		<div style="background-repeat: initial initial;padding-bottom:4px;margin-bottom:14px;line-height:1.5;padding-left:10px;padding-right:10px;padding-top:20px;font-size:12px;"><div style="background-repeat: initial initial;font-size:12px;">
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">今天在微博上看到有人说 i—比 i++ 快，我用C写了个程序测试了一下，还真的是快，难道减法运算比加法快？从原理上分析感觉不可能啊，于是深入研究了一下，终于找到原因。</p> <p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">先看一下测试代码：</p><pre style="background-repeat: initial initial;margin-top:0px;margin-bottom:0px;white-space:pre-wrap;word-wrap:break-word;margin-right:0px;margin-left:22px;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);">#include &lt;stdio.h&gt;
#include &lt;time.h&gt;

<span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> main()
{
    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> count = 1000000000;

    clock_t cl = clock ();

    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">for</span>(<span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> i = count; i &gt; 0 ; i--)
    {
    }

    printf(<span style="background-repeat: initial initial;color:rgb(0, 96, 128);font-size:13px;">&quot;Elapse %u ms\r\n&quot;</span>, (clock () - cl));

    cl = clock ();

    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">for</span>(<span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> i = 0; i &lt; count ; i++)
    {
    }

    printf(<span style="background-repeat: initial initial;color:rgb(0, 96, 128);font-size:13px;">&quot;Elapse %u ms\r\n&quot;</span>, (clock () - cl));

    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">return</span> 0;
}
</pre>


<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">以上代码在VC 2008 下编译，编译时取消优化选项（如果不取消优化的话，上面两个循环语句由于什么都没干，会被编译器优化掉)。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">运行后的结果是 <br clear="none">Elapse 2267 ms<br clear="none">Elapse 2569 ms</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">也就是说减法循环比加法循环10亿次时快300毫秒，超过10%。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">从C语言层面上分析，这两个代码几乎是一样的，我一开始也是楞了1分多钟，后来仔细比较两个代码，感觉它们的差别主要在两个地方，一个是加法和减法的差别，一个是for循环的第二个语句中一个是和立即数比较一个是和变量比较。以我掌握的计算机硬件原理知识，我首先排除了第一个差别造成性能影响的可能，那么问题很可能就出在第二个差别上，因为我知道在汇编语言中两个内存变量是不能直接比较的，中间必须要通过寄存器转储一次。这样就会多出至少一个指令。问题可能就在这里。为了验证我的判断，我们来看一下上面代码的汇编语句到底是什么样子的：</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p>
<div style="background-repeat: initial initial;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   1:  </span><span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> main()</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   2:  </span>{</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   3:  </span>00CC1000  push        ebp  </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   4:  </span>00CC1001  mov         ebp,esp </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   5:  </span>00CC1003  sub         esp,10h </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   6:  </span> </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   7:  </span>    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> count = 1000000000;</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   8:  </span>00CC1006  mov         dword ptr [count],3B9ACA00h </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">   9:  </span> </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  10:  </span> </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  11:  </span>    clock_t cl = clock ();</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  12:  </span>00CC100D  call        dword ptr [__imp__clock (0CC209Ch)] </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  13:  </span>00CC1013  mov         dword ptr [cl],eax </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  14:  </span> </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  15:  </span>    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">for</span>(<span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> i = count; i &gt; 0 ; i--)</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  16:  </span>00CC1016  mov         eax,dword ptr [count] </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  17:  </span>00CC1019  mov         dword ptr [i],eax </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  18:  </span>00CC101C  jmp         main+27h (0CC1027h) </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  19:  </span>00CC101E  mov         ecx,dword ptr [i] //把i的内存值拷贝到寄存器ecx中</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  20:  </span>00CC1021  sub         ecx,1 //ecx 减1</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  21:  </span>00CC1024  mov         dword ptr [i],ecx //把ecx 的值拷贝到i对应的内存地址,这里完成i--操作 </font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  22:  </span>00CC1027  cmp         dword ptr [i],0 //i对应的内存值和0进行比较 </font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  23:  </span>00CC102B  jle         main+2Fh (0CC102Fh) //如果小于等于0，跳转到98行</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  24:  </span>    {</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  25:  </span>    }</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  26:  </span>00CC102D  jmp         main+1Eh (0CC101Eh)//如果大于0，跳转到19行，继续循环</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  27:  </span> </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  28:  </span>    printf(<span style="background-repeat: initial initial;color:rgb(0, 96, 128);font-size:13px;">&quot;Elapse %u ms&quot;</span>, (clock () - cl));</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  29:  </span>00CC102F  call        dword ptr [__imp__clock (0CC209Ch)] </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  30:  </span>00CC1035  sub         eax,dword ptr [cl] </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  31:  </span>00CC1038  push        eax  </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  32:  </span>00CC1039  push        offset ___xi_z+30h (0CC20F4h) </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  33:  </span>00CC103E  call        dword ptr [__imp__printf (0CC20A4h)] </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  34:  </span>00CC1044  add         esp,8 </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  35:  </span> </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  36:  </span>    cl = clock ();</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  37:  </span>00CC1047  call        dword ptr [__imp__clock (0CC209Ch)] </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  38:  </span>00CC104D  mov         dword ptr [cl],eax </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  39:  </span> </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  40:  </span>    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">for</span>(<span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> i = 0; i &lt; count ; i++)</pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  41:  </span>00CC1050  mov         dword ptr [i],0 </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  42:  </span>00CC1057  jmp         main+62h (0CC1062h) </pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  43:  </span>00CC1059  mov         edx,dword ptr [i]//把i的内存值拷贝到寄存器edx中 </font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  44:  </span>00CC105C  add         edx,1 //edx 加 1 </font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  45:  </span>00CC105F  mov         dword ptr [i],edx //将edx的值拷贝到i变量对应地址 </font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  46:  </span>00CC1062  mov         eax,dword ptr [i] //将i变量值拷贝到寄存器eax中 </font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  47:  </span>00CC1065  cmp         eax,dword ptr [count] //用eax 和 count地址上的值进行比较</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  48:  </span>00CC1068  jge         main+6Ch (0CC106Ch)//如果大于等于count，跳出循环 </font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  49:  </span>    {</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  50:  </span>    }</font></pre><pre style="background-repeat: initial initial;margin-top:0em;margin-bottom:0em;white-space:pre-wrap;word-wrap:break-word;margin-right:0em;margin-left:0em;font-size:small;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);"><font color="#ff0000" style="background-repeat: initial initial;font-size:13px;"><span style="background-repeat: initial initial;color:rgb(96, 96, 96);font-size:13px;">  51:  </span>00CC106A  jmp         main+59h (0CC1059h)//否则跳转到43行继续循环</font></pre></div>


<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">我把汇编语句中的循环部分用红色标记出来，并加上注释。我们可以清楚的看到第二个循环中的汇编指令为7个，第一个为6个，也就是说第一个要比第二个要快 1/7 左右，这个和实际测试出来的结果基本上是吻合的。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">那么我们再看看为什么编译器要多一个机器指令。原因是汇编语句不可能对两个内存值直接比较，内存值只能和寄存器进行比较，这个应该是计算机硬件结构决定的，这个问题就导致编译器必须要加一个指令来转储内存值到寄存器中。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">再进一步，我们发现编译器似乎很蠢，如果在循环之前把 dword ptr[count] 拷贝到一个寄存器中，比如 ecx ，然后在46 行直接 cmp ecx, dword ptr [i] ，就不需要第47行这个指令了。但事实上编译器可能并没有蠢到这个地步，本文前面说过，我将编译器的优化给禁用了，因为如果优化的话，上面两个for循环将被完全忽略掉，根本不会执行，测试出来的时间为0秒。那么既然我们告诉编译器不优化，编译器也就不会优化这个指令，如果真的按照上面方法优化了，那么在调试环境下，如果我们想在循环中更改 count 的值就比较困难了，需要调试器来做一些编译器要做的事情。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">再深入一点，我们还会发现这个汇编语句中还有一个地方可以优化，就是 </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p><pre style="background-repeat: initial initial;margin-top:0px;margin-bottom:0px;white-space:pre-wrap;word-wrap:break-word;margin-right:0px;margin-left:22px;font-size:1em;"><font color="#ff0000" style="background-repeat: initial initial;font-size:12px;"><span style="background-repeat: initial initial;font-size:12px;">  21:  </span>00CC1024  mov         dword ptr [i],ecx //把ecx 的值拷贝到i对应的内存地址,这里完成i--操作 </font></pre><pre style="background-repeat: initial initial;margin-top:0px;margin-bottom:0px;white-space:pre-wrap;word-wrap:break-word;margin-right:0px;margin-left:22px;font-size:1em;"><font color="#ff0000" style="background-repeat: initial initial;font-size:12px;"><span style="background-repeat: initial initial;font-size:12px;">  22:  </span>00CC1027  cmp         dword ptr [i],0 //i对应的内存值和0进行比较 </font></pre>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">第22行这个地方完全可以优化为 cmp ecx, 0 </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">我们知道对寄存器的读写是最快的，其次是一级缓存，二级缓存，三级缓存，然后才是内存，最后是磁盘。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">如果22行优化为 cmp ecx, 0 其运行速度肯定要比 cmp dword ptr[i], 0 要快，因为后面的语句要进行一次寻址，从缓存中读取数据（如果CPU有缓存的话），如果没缓存，就是从内存读一次，那就更慢了。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">最后我们把i++那个循环改成</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">for(int i = 0; i &lt; 1000000000 ; i++) 再测一次，结果为</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">Elapse 2334 ms<br clear="none">Elapse 2290 ms</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">可以看出两个循环的用时基本上相等了</p><pre style="background-repeat: initial initial;margin-top:0px;margin-bottom:0px;white-space:pre-wrap;word-wrap:break-word;margin-right:0px;margin-left:22px;font-size:13px;color:black;font-family:consolas, 'Courier New', courier, monospace;background-color:rgb(255, 255, 255);">    <span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">for</span>(<span style="background-repeat: initial initial;color:rgb(0, 0, 255);font-size:13px;">int</span> i = 0; i &lt; 1000000000 ; i++)
01201050  mov         dword ptr [i],0 
01201057  jmp         main+62h (1201062h) 
<font color="#ff0000" style="background-repeat: initial initial;font-size:13px;">01201059  mov         edx,dword ptr [i] 
0120105C  add         edx,1 
0120105F  mov         dword ptr [i],edx 
01201062  cmp         dword ptr [i],3B9ACA00h 
01201069  jge         main+6Dh (120106Dh) 
    {
    }
0120106B  jmp         main+59h (1201059h)</font> </pre>


<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">看一下汇编语句，for 循环的第二句改成立即数比较后，汇编语句变成了6个指令了。所以用时也基本相同了。</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;"> </p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">结论：</p>
<p style="background-repeat: initial initial;margin-top:5px;margin-right:auto;margin-left:auto;margin-bottom:5px;text-indent:0px;font-size:12px;">i++ 和 i-- 性能是没有区别的，之所以我们感觉i--快，是因为在汇编层面上，i++ 那个循环中多了一个机器指令造成的。另外通过本文，我们也了解了一些关于汇编的指令优化的知识，希望对大家能有帮助。</p></div></div><div style="clear: both"></div></div></div>
</div></body></html> 