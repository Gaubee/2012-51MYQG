<html>
<head>
  <title>Gadget开发实战总结 1 （Gadget调用WebService）</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/267864 (zh-CN); Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1281"/>
<h1>Gadget开发实战总结 1 （Gadget调用WebService）</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 style="font-size: 14.7px; font-weight: bold; margin-bottom: 10px; color: rgb(75, 75, 75); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-style: normal; font-variant: normal; letter-spacing: normal; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><a href="http://www.cnblogs.com/yayx/archive/2007/09/04/881879.html" style="text-decoration: none; color: rgb(26, 139, 200);">Gadget开发实战总结 1 （Gadget调用WebService）</a></h1><div style="word-break: normal !important; color: rgb(75, 75, 75); font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: 19px; orphans: 2; text-align: -webkit-auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><h3 style="margin: 10px 0px; font-size: 14px; color: rgb(102, 102, 102); text-align: left; background-image: none; font-family: Verdana; background-repeat: no-repeat no-repeat;"><span style="line-height: 36px; font-size: 18pt; font-family: 宋体;">前言</span></h3><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">好久没有来这里说话了，前段时间做了一个用到</span>Vista Gadget<span style="line-height: 19px; font-family: 宋体;">的项目，难得用从未接触过的技术来做东西，自然有不少收获跟体会，跟大家分享</span>~</p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">本文阐述了一些我们在完成这个</span>Gadget<span style="line-height: 19px; font-family: 宋体;">项目中遇到的问题，希望和大家一起探讨一下</span>Gadget<span style="line-height: 19px; font-family: 宋体;">的开发和应用。</span></p><h3 style="margin: 10px 0px; font-size: 14px; color: rgb(102, 102, 102); text-align: left; background-image: none; font-family: Verdana; background-repeat: no-repeat no-repeat;"><span style="line-height: 36px; font-size: 18pt; font-family: 宋体;">准备</span></h3><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">前段时间</span>Csdn<span style="line-height: 19px; font-family: 宋体;">搞了</span>Gadget<span style="line-height: 19px; font-family: 宋体;">开发大赛，摆明了就是</span>MS<span style="line-height: 19px; font-family: 宋体;">宣传它的新东西。当时自己一没什么好的创意，二也没什么时间来研究这东西。不过</span>Gadget<span style="line-height: 19px; font-family: 宋体;">大赛中后来获奖一些作品还是给我留下了挺深的印象。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">这回暑假在做学校里的比赛，正好碰到一个应用感觉很合适用</span>Gadget<span style="line-height: 19px; font-family: 宋体;">来做，几番评估之后，决定用</span>Gadget<span style="line-height: 19px; font-family: 宋体;">来做，也算是给</span>MS<span style="line-height: 19px; font-family: 宋体;">给</span>Vista<span style="line-height: 19px; font-family: 宋体;">做做广告</span>^_^</p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">大概介绍一下我们所要做的应用。服务端计划使用</span>.net<span style="line-height: 19px; font-family: 宋体;">平台实现，有已经封装好的数据访问架构，客户端计划使用</span>Gadget,<span style="line-height: 19px; font-family: 宋体;">除了一般的信息浏览之外，我们希望客户端还能够完成客户的登录注销等操作。在用户登录后，客户端有需要频繁和服务端进行数据的双向交互，并且还需要进行一些数据的本地保存操作。整个模式可以类比一下</span>QQ~<span style="line-height: 19px; font-family: 宋体;">不过我们的客户端是</span>Gadget</p><h3 style="margin: 10px 0px; font-size: 14px; color: rgb(102, 102, 102); text-align: left; background-image: none; font-family: Verdana; background-repeat: no-repeat no-repeat;"><span style="line-height: 36px; font-size: 18pt; font-family: 宋体;">开始</span></h3><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">在学校里做东西</span>,<span style="line-height: 19px; font-family: 宋体;">不同于企业开发</span>,<span style="line-height: 19px; font-family: 宋体;">边学边做是肯定的了</span>~<span style="line-height: 19px; font-family: 宋体;">在明确了客户端的需求之后，我们开始寻找</span>Gadget<span style="line-height: 19px; font-family: 宋体;">的开发资料，这其中包括了</span>MSDN<span style="line-height: 19px; font-family: 宋体;">中的</span>Gadget<span style="line-height: 19px; font-family: 宋体;">开发文档，还有一些如</span>Gadget<span style="line-height: 19px; font-family: 宋体;">开发白皮书一类的东西。网上资料很多，</span>cnblogs<span style="line-height: 19px; font-family: 宋体;">也是个好地方</span>~</p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">经过不是很长时间的学习，我们已经搞清楚了</span>Gadget<span style="line-height: 19px; font-family: 宋体;">的模式，它本身其实就是一个特殊的“网页”，逻辑通通用</span>JS<span style="line-height: 19px; font-family: 宋体;">控制。不同的只是这个网页中可以使用</span>System.Gadget<span style="line-height: 19px; font-family: 宋体;">等一些特殊的类。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">与此同时，服务端的开发进度也很快，系统需要的一些业务逻辑和界面逻辑很快就实现了。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">一切看起来还算顺利，这时候开发进度表上感觉很好，应该没几天就可以完成开发了。不过问题还是出现了</span>~~</p><h3 style="margin: 10px 0px; font-size: 14px; color: rgb(102, 102, 102); text-align: left; background-image: none; font-family: Verdana; background-repeat: no-repeat no-repeat;"><span style="line-height: 21px; font-family: 宋体;">第一个问题</span>–<span> </span><span style="line-height: 21px; font-family: 宋体;">数据交换</span></h3><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">刚开始的问题主要出在</span>Gadget<span style="line-height: 19px; font-family: 宋体;">和服务端的数据交换方式上。</span></p><h4><span style="line-height: 19px; font-family: 宋体;">怎么访问服务器？</span></h4><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">根据我们找到的一些</span>Gadget<span style="line-height: 19px; font-family: 宋体;">代码分析，</span>Gadget<span style="line-height: 19px; font-family: 宋体;">和服务端交互主要有两种方式：</span></p><p style="line-height: 19px; margin: 5px auto 5px 21pt; text-indent: -21pt;">1.<span style="line-height: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times New Roman';">        <span> </span></span><span style="line-height: 19px; font-family: 宋体;">使用</span>AJAX,<span style="line-height: 19px; font-family: 宋体;">也就是用</span>HttpRequest<span style="line-height: 19px; font-family: 宋体;">这个东西在后台发送对服务端的请求，获取服务端数据</span></p><p style="line-height: 19px; margin: 5px auto 5px 21pt; text-indent: -21pt;">2.<span style="line-height: normal; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; font-family: 'Times New Roman';">        <span> </span></span><span style="line-height: 19px; font-family: 宋体;">实现自己的</span>ActiveX<span style="line-height: 19px; font-family: 宋体;">控件，在</span>Javascript<span style="line-height: 19px; font-family: 宋体;">中调用，在</span>ActiveX<span style="line-height: 19px; font-family: 宋体;">中进行和服务端的交互</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;">Windows Vista<span style="line-height: 19px; font-family: 宋体;">自带的那几个</span>Gadget<span style="line-height: 19px; font-family: 宋体;">程序都使用了自己的</span>ActiveX<span style="line-height: 19px; font-family: 宋体;">控件，访问代码类似这样。<br></span></p><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 922px; word-break: break-all; background-color: rgb(238, 238, 238);"><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image.gif" type="image/gif" align="top" style="cursor: default;"/><span style="line-height: 19px; color: rgb(0, 0, 0);">             </span><span style="line-height: 19px; color: rgb(0, 0, 255);">try</span><span style="line-height: 19px; color: rgb(0, 0, 0);"><br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [1].gif" type="image/gif" align="top" style="cursor: default;"/>             </span><span style="line-height: 19px;"><span style="line-height: 19px; color: rgb(0, 0, 0);">{<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [2].gif" type="image/gif" align="top" style="cursor: default;"/>                   </span><span style="line-height: 19px; color: rgb(0, 0, 255);">var</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> o </span><span style="line-height: 19px; color: rgb(0, 0, 0);">=</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> </span><span style="line-height: 19px; color: rgb(0, 0, 255);">new</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> ActiveXObject(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">wlsrvc.WLServices</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">);<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [3].gif" type="image/gif" align="top" style="cursor: default;"/>                    stocks.msn.service </span><span style="line-height: 19px; color: rgb(0, 0, 0);">=</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> o.GetService(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">stock</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">);<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [4].gif" type="image/gif" align="top" style="cursor: default;"/>                    </span><span style="line-height: 19px; color: rgb(0, 0, 255);">if</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> (stocks.msn.status.availability.active)<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [5].gif" type="image/gif" align="top" style="cursor: default;"/>                    </span><span style="line-height: 19px;"><span style="line-height: 19px; color: rgb(0, 0, 0);">{<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [6].gif" type="image/gif" align="top" style="cursor: default;"/>                        stocks.msn.init();<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [7].gif" type="image/gif" align="top" style="cursor: default;"/>                    }</span></span><span style="line-height: 19px; color: rgb(0, 0, 0);"><br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [8].gif" type="image/gif" align="top" style="cursor: default;"/>                    </span><span style="line-height: 19px; color: rgb(0, 0, 255);">else</span><span style="line-height: 19px; color: rgb(0, 0, 0);"><br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [9].gif" type="image/gif" align="top" style="cursor: default;"/>                    </span><span style="line-height: 19px;"><span style="line-height: 19px; color: rgb(0, 0, 0);">{<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [10].gif" type="image/gif" align="top" style="cursor: default;"/>                        stocks.msn.status.ping.update(</span><span style="line-height: 19px; color: rgb(0, 0, 255);">false</span><span style="line-height: 19px; color: rgb(0, 0, 0);">, (stocks.msn.status.availability.error </span><span style="line-height: 19px; color: rgb(0, 0, 0);">!=</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> </span><span style="line-height: 19px; color: rgb(0, 0, 255);">null</span><span style="line-height: 19px; color: rgb(0, 0, 0);">));<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [11].gif" type="image/gif" align="top" style="cursor: default;"/>                    }</span></span><span style="line-height: 19px; color: rgb(0, 0, 0);"><br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [12].gif" type="image/gif" align="top" style="cursor: default;"/>                }</span></span></div><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"> </p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">本来我们以为那个控件提供了</span>Gadget<span style="line-height: 19px; font-family: 宋体;">访问网络的方式，后来对代码的研究却发现这个叫</span>wlsrvc.dll<span style="line-height: 19px; font-family: 宋体;">的</span>ActiveX<span style="line-height: 19px; font-family: 宋体;">控件本身就封装了所有的访问逻辑。例如上面的代码：使用</span>GetService<span style="line-height: 19px; font-family: 宋体;">方法只传入了一个</span>”stock”<span style="line-height: 19px; font-family: 宋体;">字符串，</span>wlsrvc<span style="line-height: 19px; font-family: 宋体;">就返回了一个</span>service<span style="line-height: 19px; font-family: 宋体;">对象。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">自带的那几个需要访问网络的</span>Gadget<span style="line-height: 19px; font-family: 宋体;">都用了这个</span>ActiveX<span style="line-height: 19px; font-family: 宋体;">，不同只是在于传入的初始化字符串不同，原来</span>wlsrvc.dll<span style="line-height: 19px; font-family: 宋体;">只是一个</span>Windows Vista<span style="line-height: 19px; font-family: 宋体;">自带</span>Gadget<span style="line-height: 19px; font-family: 宋体;">专用的简单工厂</span>…</p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">这让我们很郁闷，</span>MS<span style="line-height: 19px; font-family: 宋体;">太霸道了。</span>Wlsrvc<span style="line-height: 19px; font-family: 宋体;">没有任何文档，自带的</span>Gadget<span style="line-height: 19px; font-family: 宋体;">连个原来是个没源代码的东西</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">而网上的大部分</span>Gadget<span style="line-height: 19px; font-family: 宋体;">都是采用第一种方式和服务端交互的。</span>Ajax<span style="line-height: 19px; font-family: 宋体;">技术已经趋向于成熟，大家都在用</span>~</p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">代码类似这样</span>:<br></p><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 922px; word-break: break-all; background-color: rgb(238, 238, 238);"><span style="line-height: 19px; color: rgb(0, 0, 255);">function</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> CreatHttpRequest()<br>
{<br>
    ListLoading();<br>
    HttpRequest </span><span style="line-height: 19px; color: rgb(0, 0, 0);">=</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> </span><span style="line-height: 19px; color: rgb(0, 0, 255);">new</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> ActiveXObject(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">Microsoft.XMLHTTP</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">);<br>
    HttpRequest.onreadystatechange </span><span style="line-height: 19px; color: rgb(0, 0, 0);">=</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> ListProcessResponse;<br>
    HttpRequest.open(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">GET</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">,”http:</span><span style="line-height: 19px; color: rgb(0, 128, 0);">//</span><span style="line-height: 19px; color: rgb(0, 128, 0);">xxx.com/sss.ashx”,true);</span><span style="line-height: 19px; color: rgb(0, 128, 0);"><br></span><span style="line-height: 19px; color: rgb(0, 0, 0);">    HttpRequest.setRequestHeader(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">If-Modified-Since</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">,</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">0</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">);<br>
    </span><span style="line-height: 19px; color: rgb(0, 0, 255);">try</span><span style="line-height: 19px; color: rgb(0, 0, 0);"><br>
    {<br>
        HttpRequest.send();<br>
    } </span><span style="line-height: 19px; color: rgb(0, 0, 255);">catch</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> (e)<br>
    {    }<br>
}<br></span></div><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;"><br>
然后就可以通过</span>HttpRequest<span style="line-height: 19px; font-family: 宋体;">回调函数进行数据获取。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">基本上就是传入一个参数，返回一个</span>request<span style="line-height: 19px; font-family: 宋体;">，相信做过</span>ajax<span style="line-height: 19px; font-family: 宋体;">开发的对这样的方式应该会很熟悉。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">顺便说一句，在</span>Gadget<span style="line-height: 19px; font-family: 宋体;">中，</span>HttpRequest<span style="line-height: 19px; font-family: 宋体;">是有足够的权限直接进行跨域访问的，不会类似网页中</span>Ajax<span style="line-height: 19px; font-family: 宋体;">一样跨域操作时出现“拒绝访问”的错误。</span></p><h4><span style="line-height: 19px; font-family: 宋体;">天啊，代码怎么写？</span></h4><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">问题是：我们需要和服务器进行较多的复杂的交互，比如各种客户端数据的提交，服务端返回的数据结构也比较复杂。虽说在客户端和服务端我们都定义了一些例如</span>UserInfo<span style="line-height: 19px; font-family: 宋体;">这样的实体类来进行数据的传播，但是纯粹使用</span>HttpRequest<span style="line-height: 19px; font-family: 宋体;">实现这个东西来进行数据交互显然让代码变得非常的复杂。。。而且，</span>Gadget<span style="line-height: 19px; font-family: 宋体;">的客户端并非</span>WebForm<span style="line-height: 19px; font-family: 宋体;">那样拥有强大的服务端功能，甚至连个调试器都没有，我们一直在用</span>Notepad++<span style="line-height: 19px; font-family: 宋体;">写代码</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">想起来一句话：</span>AJAX<span style="line-height: 19px; font-family: 宋体;">让用户成了皇帝，而开发者成了奴隶。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">我们预估了一下复杂度，即使使用例如</span>Prototype<span style="line-height: 19px; font-family: 宋体;">这样的第三方库来简化</span>Gadget<span style="line-height: 19px; font-family: 宋体;">客户端的代码编写，</span>ashx<span style="line-height: 19px; font-family: 宋体;">页面的编写也是一个相当麻烦的问题。或许我们可以为每一种交互编写不同的</span>ashx<span style="line-height: 19px; font-family: 宋体;">页面，但这一定不是一个好主意。很难想象服务端被做成一个拥有十几个</span>ashx<span style="line-height: 19px; font-family: 宋体;">页面的</span>”<span style="line-height: 19px; font-family: 宋体;">网站</span>”<span style="line-height: 19px; font-family: 宋体;">是什么样子。即使把所有的调用统一到一个</span>ashx<span style="line-height: 19px; font-family: 宋体;">页面中，这个页面中的代码也必定有着很强的耦合性（一个页面要处理十几种不同的请求），特别是客户端，需要在一个回调函数中处理十多种不同的返回值，代码的冗杂几乎也是很容易想象到的。我们想到的唯一办法就是使用设计模式让代码简洁好看一些，但</span>Javascript<span style="line-height: 19px; font-family: 宋体;">这东西天生就不那么方便“搞对象”。更多的对象也只能让</span>Javascript<span style="line-height: 19px; font-family: 宋体;">代码更乱。</span></p><h4><span style="line-height: 19px; font-family: 宋体;">使用</span>WebService<span style="line-height: 19px; font-family: 宋体;">解决问题</span></h4><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">上面唠唠叨叨说了大半天，也就是要阐述我们对</span>Gadget<span style="line-height: 19px; font-family: 宋体;">的需求超过了一般对</span>Gadget<span style="line-height: 19px; font-family: 宋体;">的定义——我们希望像做</span>WinForm<span style="line-height: 19px; font-family: 宋体;">或者</span>WebForm<span style="line-height: 19px; font-family: 宋体;">一样的来做</span>Gadget<span style="line-height: 19px; font-family: 宋体;">程序，而一般定义的</span>Gadget<span style="line-height: 19px; font-family: 宋体;">似乎只是一个简单的信息显示工具，并不会涉及复杂的逻辑。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">于是我们希望使用</span>WebService<span style="line-height: 19px; font-family: 宋体;">这个东西来解决这个问题。大体的思路就是服务端将接口抽象为</span>WebService,<span style="line-height: 19px; font-family: 宋体;">客户端只需要调用它提供的一些函数。因为</span>WebService<span style="line-height: 19px; font-family: 宋体;">基于</span>HTTP<span style="line-height: 19px; font-family: 宋体;">协议，因此</span>Javascrip<span style="line-height: 19px; font-family: 宋体;">理论上是完全能够调用的。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">在服务端使用</span>C#<span style="line-height: 19px; font-family: 宋体;">封装出一个</span>asmx<span style="line-height: 19px; font-family: 宋体;">已经是如此的简单，我们几乎只需要重新抽象一遍接口，并且然后加上</span>[WebMethod]<span style="line-height: 19px; font-family: 宋体;">。</span></p><h4><span style="line-height: 19px; font-family: 宋体;">在</span>Gadget<span style="line-height: 19px; font-family: 宋体;">中调用</span>WebService</h4><h5><span style="line-height: 18px; font-family: 宋体;">用</span>Webservice.htc<span style="line-height: 18px; font-family: 宋体;">失败</span></h5><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">下面的问题是如何使用</span>Javascript<span style="line-height: 19px; font-family: 宋体;">调用</span>WebService<span style="line-height: 19px; font-family: 宋体;">，没费多少力气我们就找到了一个很经典的</span>Webservice.htc<span style="line-height: 19px; font-family: 宋体;">。这是一个</span>MS<span style="line-height: 19px; font-family: 宋体;">出的挺完善的</span>JS<span style="line-height: 19px; font-family: 宋体;">调用</span>WebService<span style="line-height: 19px; font-family: 宋体;">的组件。</span>(<span style="line-height: 19px; font-family: 宋体;">一个例程请参考：</span><a href="http://blog.csdn.net/yangyifan0/archive/2005/12/08/546923.aspx" style="color: rgb(26, 139, 200); text-decoration: none;">http://blog.csdn.net/yangyifan0/archive/2005/12/08/546923.aspx</a>)</p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">这时候进度一下子就拉快了，这个组件使用方法非常简单。我们的</span>WebService<span style="line-height: 19px; font-family: 宋体;">没有返回通常用的</span>DataSet<span style="line-height: 19px; font-family: 宋体;">而是直接返回的</span>C#<span style="line-height: 19px; font-family: 宋体;">实体类，使用</span>Soap<span style="line-height: 19px; font-family: 宋体;">协议访问时，实体类会被序列化成</span>XML<span style="line-height: 19px; font-family: 宋体;">，</span>javascript<span style="line-height: 19px; font-family: 宋体;">可以直接的解析这些</span>XML<span style="line-height: 19px; font-family: 宋体;">为</span>Javascript<span style="line-height: 19px; font-family: 宋体;">的类，虽然效率不那么很高，但这样让程序变得非常简洁。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">详细的用法可以参照</span>WebService.htc<span style="line-height: 19px; font-family: 宋体;">的帮助文件。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">好像项目就快要完成了，不过这时候令人很郁闷的事情又发生了。</span>WebService.htc<span style="line-height: 19px; font-family: 宋体;">这个文件在</span>Gadget<span style="line-height: 19px; font-family: 宋体;">中无论如何不起作用！～</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">我搞不清楚具体的原因到底是什么，感觉和安全有关，因为这个组件本身能够在网页中实现跨域进行</span>WebService<span style="line-height: 19px; font-family: 宋体;">调用，似乎用了什么怪异的机制而非</span>HttpRequest<span style="line-height: 19px; font-family: 宋体;">，这我并没有仔细研究，反正在</span>Gadget<span style="line-height: 19px; font-family: 宋体;">中它不能用就是了。</span></p><h5><span style="line-height: 18px; font-family: 宋体;">用</span>SOAP Client<span style="line-height: 18px; font-family: 宋体;">成功</span></h5><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">不知道这个时候提到</span><span> </span>SOAP Client<span style="line-height: 19px; font-family: 宋体;">这个东西是不是有些做软广告的嫌疑。不过在经过一番搜索之后，我们确定了我们唯一能走的路就是自己通过</span>HttpRequest<span style="line-height: 19px; font-family: 宋体;">向服务器发送</span>SOAP<span style="line-height: 19px; font-family: 宋体;">，并且进行交互。又经过一番搜索之后我们找到了</span>SOAP Client<span style="line-height: 19px; font-family: 宋体;">这个东西</span>(<span style="line-height: 19px; font-family: 宋体;">开源的，大家可以研究研究，其实本身原理很简单</span>)<span style="line-height: 19px; font-family: 宋体;">。</span>(http://www.guru4.net/articoli/javascript-soap-client/)</p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">详细过程省略，一番调试，我们成功实现了在</span>Gadget<span style="line-height: 19px; font-family: 宋体;">中调用</span>WebService,<span style="line-height: 19px; font-family: 宋体;">经过再一次的封装，</span>Javascript<span style="line-height: 19px; font-family: 宋体;">甚至可以像使用本地的方法一样方便的使用服务端提供的</span>GetxxxInfo<span style="line-height: 19px; font-family: 宋体;">这样的方法。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">最后得到的实例代码如下：</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">服务端：</span></p><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 922px; word-break: break-all; background-color: rgb(238, 238, 238);"><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [13].gif" type="image/gif" align="top" style="cursor: default;"/><span style="line-height: 19px; color: rgb(0, 0, 0);">[WebMethod(Description </span><span style="line-height: 19px; color: rgb(0, 0, 0);">=</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> </span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">获取xxxx详细信息</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">)]<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [14].gif" type="image/gif" align="top" style="cursor: default;"/></span><span style="line-height: 19px; color: rgb(0, 0, 255);">public</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> XxxxInfo GetXxxxInfo (XxxxQueryInfo info, </span><span style="line-height: 19px; color: rgb(0, 0, 255);">string</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> context)<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [15].gif" type="image/gif" align="top" style="cursor: default;"/></span><span style="line-height: 19px;"><span style="line-height: 19px; color: rgb(0, 0, 0);">{<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [16].gif" type="image/gif" align="top" style="cursor: default;"/> …<br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [17].gif" type="image/gif" align="top" style="cursor: default;"/>}</span></span><span style="line-height: 19px; color: rgb(0, 0, 0);"><br><img src="Gadget开发实战总结 1 （Gadget调用WebService）_files/Image [18].gif" type="image/gif" align="top" style="cursor: default;"/></span></div><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"> </p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;">XxxxInfo<span style="line-height: 19px; font-family: 宋体;">和</span>XxxxQueryInfo<span style="line-height: 19px; font-family: 宋体;">是两个实体类，里面定义了一些如</span>Username<span style="line-height: 19px; font-family: 宋体;">这样的字段供访问</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">客户端：</span></p><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 922px; word-break: break-all; background-color: rgb(238, 238, 238);"><span style="line-height: 19px; color: rgb(0, 0, 255);">function</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> GetXxxxInfo(sendIdentities, text, clientGuid)<br>
{   </span><span style="line-height: 19px; color: rgb(0, 0, 255);">var</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> pl </span><span style="line-height: 19px; color: rgb(0, 0, 0);">=</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> </span><span style="line-height: 19px; color: rgb(0, 0, 255);">new</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> SOAPClientParameters();<br>
    pl.add(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">Identities</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">,sendIdentities );<br>
    pl.add(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">message</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">,text );<br>
    pl.add(</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">clientGuid</span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">,clientGuid );<br>
    SOAPClient.invoke(url, </span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);"> GetXxxxInfo </span><span style="line-height: 19px; color: rgb(0, 0, 0);">&quot;</span><span style="line-height: 19px; color: rgb(0, 0, 0);">, pl, </span><span style="line-height: 19px; color: rgb(0, 0, 255);">true</span><span style="line-height: 19px; color: rgb(0, 0, 0);">,</span><span style="line-height: 19px; color: rgb(0, 0, 255);">function</span><span style="line-height: 19px; color: rgb(0, 0, 0);">(r)<br>
    {<br>
        </span><span style="line-height: 19px; color: rgb(0, 128, 0);">//</span><span style="line-height: 19px; color: rgb(0, 128, 0);">This is the Callback Function</span><span style="line-height: 19px; color: rgb(0, 128, 0);"><br></span><span style="line-height: 19px; color: rgb(0, 0, 0);">    }) <br>
}<br></span></div><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"> </p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">只是构造几个参数，写一个回调函数然后传给服务端就行了，很简单</span></p><h5>Gadget<span style="line-height: 18px; font-family: 宋体;">中调用</span>Webservice<span style="line-height: 18px; font-family: 宋体;">总结</span></h5><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;">Gadget<span style="line-height: 19px; font-family: 宋体;">中与服务器交互的方式除了自己写</span>ActiveX<span style="line-height: 19px; font-family: 宋体;">控件之外似乎只能使用</span>HttpRequest<span style="line-height: 19px; font-family: 宋体;">来进行页面的请求。对于一般的简单请求（比如只需要传入一个单词字符串请求一个单词的翻译），可以像一般的</span>ajax<span style="line-height: 19px; font-family: 宋体;">一样实现一个</span>ashx<span style="line-height: 19px; font-family: 宋体;">页面来处理请求。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">如果遇到比较复杂的请求，可以考虑使用</span>WebService<span style="line-height: 19px; font-family: 宋体;">，</span>WebService<span style="line-height: 19px; font-family: 宋体;">由于通过</span>HTTP<span style="line-height: 19px; font-family: 宋体;">下的</span>SOAP<span style="line-height: 19px; font-family: 宋体;">协议传送程序数据，所以非常合适</span>Javascript<span style="line-height: 19px; font-family: 宋体;">和各种服务端的交互。但是在客户端实现</span>SOAP<span style="line-height: 19px; font-family: 宋体;">到</span>Javascript<span style="line-height: 19px; font-family: 宋体;">的转换是需要不少代码的，如果完全自己实现，恐怕是有相当的工作量的，不过，</span>SOAP Client<span style="line-height: 19px; font-family: 宋体;">这个库实现了这个工作。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">这个方案只是我们经过几天的探索所得出的一些结果，至于有没有其他更好用的方法，我想应该还是有的，希望大家指教了。</span></p><h2><span style="line-height: 36px; font-size: 18pt; font-family: 宋体;">休息一下</span></h2><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">到这里为止，我阐述了在</span>Gadget<span style="line-height: 19px; font-family: 宋体;">开发中遇到的客户端和服务端数据交换的问题及其解决方案。没有给出特别详细的代码，如果有看不明白的地方请指出来（我也是就偷个懒，呵呵）。</span></p><p style="line-height: 19px; margin: 5px auto; text-indent: 0px;"><span style="line-height: 19px; font-family: 宋体;">写到这里先休息一下，下面我还计划讲讲开发中遇到的其他问题以及体会，主要包括</span>Gadget<span style="line-height: 19px; font-family: 宋体;">上极其困扰我们的</span>”I See Pink” Problem<span style="line-height: 19px; font-family: 宋体;">以及文件操作，界面定位，时间操作等地方遇到的麻烦。</span></p></div></div>
</div></body></html> 